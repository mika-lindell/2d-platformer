var utils;utils={now:function(){return(new Date).getTime()},snap:function(t,e){return Math.floor(t/e)*e},rand:function(t,e){var r;return null==e&&(e=t,t=0),r=e-t,Math.floor(Math.random()*r)+t}};var gfx;gfx={tileW:24,tileH:24,init:function(){var t;return t=document.querySelector("#game"),this.ctx=null!=t?"function"==typeof t.getContext?t.getContext("2d"):void 0:void 0,this.ctx?(this.w=t.width,this.h=t.height,!0):!1},clear:function(){return this.ctx.clearRect(0,0,gfx.w,gfx.h)},load:function(t){return this.sprites=new Image,this.sprites.src="resources/sprites.png",this.sprites.onload=function(){return t()}},drawSprite:function(t,e,r,n,i,o,s){return null==i&&(i=1),null==o&&(o=1),null==s&&(s=1),i*=this.tileW,o*=this.tileH,this.ctx.drawImage(this.sprites,t*i,e*o,i,o,r,n,i*s,o*s)}};var keys;keys={up:!1,down:!1,left:!1,right:!1,space:!1,reset:function(){return this.up=this.down=this.left=this.right=this.space=!1},trigger:function(t,e,r){switch(t){case 37:this.left=e;break;case 39:this.right=e;break;case 38:this.up=e;break;case 40:this.down=e;break;case 32:e&&console.log("FIRE!"),this.space=e}return r.preventDefault()}},document.addEventListener("keydown",function(t){return keys.trigger(t.keyCode,!0,t)},!1),document.addEventListener("keyup",function(t){return keys.trigger(t.keyCode,!1,t)},!1);var Entity;Entity=function(){function t(t,e,r){this.level=t,this.x=e,this.y=r,this.falling=!0,this.wasFalling=!0,this.onLadder=!1,this.wasOnLadder=!1,this.onTopOfLadder=!1}return t.prototype.x=0,t.prototype.y=0,t.prototype.w=18,t.prototype.h=24,t.prototype.speed=4,t.prototype.dir="LEFT",t.prototype.update=function(){},t.prototype.render=function(t){return t.ctx.fillText("?",this.x,this.y)},t.prototype.move=function(t,e){var r,n,i,o,s,h,p,u,l,a;return this.falling&&(e+=2*this.speed),this.wasFalling=this.falling,s=t,p=e,h=this.x+s,u=this.y+p,l=this.level.getBlocks([this.x,u],[this.x,u+(this.h-1)],[this.x+(this.w-1),u],[this.x+(this.w-1),u+(this.h-1)]),i=l[0],r=l[1],o=l[2],n=l[3],0>e&&(i.solid||o.solid)&&(p=this.level.getBlockEdge(this.y,"VERT")-this.y),e>0&&(r.solid||n.solid)&&(p=this.level.getBlockEdge(u+(this.h-1),"VERT")-this.y-this.h,this.falling=!1),a=this.level.getBlocks([h,this.y],[h,this.y+(this.h-1)],[h+(this.w-1),this.y],[h+(this.w-1),this.y+(this.h-1)]),i=a[0],r=a[1],o=a[2],n=a[3],0>t&&(i.solid||r.solid)&&(s=this.level.getBlockEdge(this.x)-this.x),t>0&&(o.solid||n.solid)&&(s=this.level.getBlockEdge(h+(this.w-1))-this.x-this.w),this.x+=s,this.y+=p,this.checkNewPos(t,e)},t.prototype.checkNewPos=function(t,e){var r,n,i,o,s,h,p,u,l,a,c;for(this.wasOnLadder=this.onLadder,c=this.level.getBlocks([this.x,this.y],[this.x,this.y+this.h],[this.x+(this.w-1),this.y],[this.x+(this.w-1),this.y+this.h]),h=c[0],r=c[1],u=c[2],i=c[3],o=c,l=0,a=o.length;a>l;l++)n=o[l],n.touchable&&n.touch(this);return this.onLadder=!1,p=o.some(function(t){return t.climbable}),p&&(this.onLadder=!0,this.falling=!1,0!==e&&(s=utils.snap(this.x,gfx.tileW),r.climbable||h.climbable||(this.x=s+gfx.tileW),i.climbable||u.climbable||(this.x=s))),this.onTopOfLadder=this.onLadder&&!(h.climbable||u.climbable)&&0===(this.y+this.h)%gfx.tileH,this.onLadder||this.falling||r.solid||i.solid||r.climbable||i.climbable?void 0:this.falling=!0},t}();var Ninja,__hasProp={}.hasOwnProperty,__extends=function(t,e){function r(){this.constructor=t}for(var n in e)__hasProp.call(e,n)&&(t[n]=e[n]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t};Ninja=function(t){function e(t,r,n,i){this.player=i,e.__super__.constructor.call(this,t,r,n)}return __extends(e,t),e.prototype.state="CRUISING",e.prototype.subState="IDLE",e.prototype.speed=3,e.prototype.time=0,e.prototype.render=function(t){return t.drawSprite(0,1,this.x,this.y)},e.prototype.cruise=function(t,e){var r,n,i;switch(n=i=0,this.subState){case"RIGHT":n+=this.speed,this.dir="RIGHT";break;case"LEFT":n-=this.speed,this.dir="LEFT"}return--this.time<0&&(r=utils.rand(5),this.time=utils.rand(20,40),this.subState=function(){switch(r){case 0:case 1:return"LEFT";case 2:case 3:return"RIGHT";default:return"IDLE"}}()),this.onLadder&&!this.wasOnLadder&&Math.random()<.5&&(this.state="HUNTING"),e===this.y&&(this.state="HUNTING"),[n,i]},e.prototype.hunt=function(t,e){var r,n;return r=n=0,e===this.y||this.onTopOfLadder?t>this.x?(r+=this.speed,this.dir="RIGHT"):(r-=this.speed,this.dir="LEFT"):this.onLadder?(!this.onTopOfLadder&&e<this.y&&(n-=this.speed),e>this.y&&(n+=this.speed)):(this.state="CRUISING",this.subState="LEFT"),[r,n]},e.prototype.update=function(){var t,e,r,n,i;return i=function(){var r;if(this.falling)return[0,0];switch(r=this.player,t=r.x,e=r.y,this.state){case"CRUISING":return this.cruise(t,e);case"HUNTING":return this.hunt(t,e)}}.call(this),r=i[0],n=i[1],this.move(r,n)},e}(Entity);var Player,__hasProp={}.hasOwnProperty,__extends=function(t,e){function r(){this.constructor=t}for(var n in e)__hasProp.call(e,n)&&(t[n]=e[n]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t};Player=function(t){function e(){e.__super__.constructor.apply(this,arguments),this.dir="RIGHT"}return __extends(e,t),e.prototype.update=function(){var t,e;return t=e=0,this.falling||(keys.left&&(t-=this.speed,this.dir="LEFT"),keys.right&&(t+=this.speed,this.dir="RIGHT")),keys.down&&this.onLadder&&(e+=this.speed),keys.up&&this.onLadder&&!this.onTopOfLadder&&(e-=this.speed),keys.space&&this.dig(),this.move(t,e)},e.prototype.render=function(t){return t.drawSprite(0,0,this.x,this.y)},e.prototype.dig=function(){return utils.now()-this.lastDig<500?void 0:(this.level.digAt(this.dir,this.x,this.y),this.lastDig=utils.now())},e}(Entity);var Block;Block=function(){function t(){}return t.prototype.touchable=!1,t.prototype.solid=!1,t.prototype.climbable=!1,t.prototype.update=function(){},t.prototype.render=function(){},t}();var Treasure,__hasProp={}.hasOwnProperty,__extends=function(t,e){function r(){this.constructor=t}for(var n in e)__hasProp.call(e,n)&&(t[n]=e[n]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t};Treasure=function(t){function e(){this.yOff=Math.random()*Math.PI}return __extends(e,t),e.prototype.touchable=!0,e.prototype.collected=!1,e.prototype.touch=function(t){return t.constructor===Player?this.collected=!0:void 0},e.prototype.update=function(t,e,r){return this.yOff+=Math.PI/24,this.collected?r.removeBlock(t,e,this):void 0},e.prototype.render=function(t,e,r){var n;return n=Math.floor(4*Math.sin(this.yOff)),t.drawSprite(5,1,e,r+n)},e}(Block);var Dirt,_ref,__hasProp={}.hasOwnProperty,__extends=function(t,e){function r(){this.constructor=t}for(var n in e)__hasProp.call(e,n)&&(t[n]=e[n]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t};Dirt=function(t){function e(){return _ref=e.__super__.constructor.apply(this,arguments)}return __extends(e,t),e.prototype.solid=!0,e.prototype.render=function(t,e,r){var n;return n=t.ctx.globalAlpha,t.ctx.globalAlpha=1-this.digTime/80,t.drawSprite(4,1,e,r),t.ctx.globalAlpha=n},e.prototype.digIt=function(){return this.digTime=80,this.solid=!1},e.prototype.update=function(){return 50===--this.digTime?this.solid=!0:void 0},e}(Block);var Gravel,_ref,__hasProp={}.hasOwnProperty,__extends=function(t,e){function r(){this.constructor=t}for(var n in e)__hasProp.call(e,n)&&(t[n]=e[n]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t};Gravel=function(t){function e(){return _ref=e.__super__.constructor.apply(this,arguments)}return __extends(e,t),e.prototype.solid=!0,e.prototype.digTime=100,e.prototype.update=function(t,e,r){return--this.digTime<0?r.removeBlock(t,e,this):void 0},e.prototype.render=function(t,e,r){var n;return n=t.ctx.globalAlpha,t.ctx.globalAlpha=this.digTime/50,t.drawSprite(4,2,e,r),t.ctx.globalAlpha=n},e}(Block);var Rock,_ref,__hasProp={}.hasOwnProperty,__extends=function(t,e){function r(){this.constructor=t}for(var n in e)__hasProp.call(e,n)&&(t[n]=e[n]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t};Rock=function(t){function e(){return _ref=e.__super__.constructor.apply(this,arguments)}return __extends(e,t),e.prototype.solid=!0,e.prototype.render=function(t,e,r){return t.drawSprite(4,0,e,r)},e}(Block);var Ladder,__hasProp={}.hasOwnProperty,__extends=function(t,e){function r(){this.constructor=t}for(var n in e)__hasProp.call(e,n)&&(t[n]=e[n]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t};Ladder=function(t){function e(t){this.top=t,this.frame=t?6:5}return __extends(e,t),e.prototype.climbable=!0,e.prototype.render=function(t,e,r){return t.drawSprite(this.frame,0,e,r)},e}(Block);var levels;levels=[{name:"DIG and BUILD",data:"..................X.....\n@-@@.........@@@@@@@-@..\n.#..@@@....P........#...\n.#.....@@.@@.....X..#...\n@OO#.........#@@...O#..^\n...#.........#......#.^O\n...#..@@-@@@@#..-@@@@@OO\n...#....#....#..#.......\n...#....#....#..#.......\n...#....#....#..#.......\n@-@@OOOOO.#.@@@@@#@@-@@@\n.#.X......#......#..#...\n.#...*....#......#..#...\n####..@@#@@..-@@@@@@@..*\n####....#....#.........#\n####....#....#.........#\nOOOOOOOOOOOOOOOOOOOOOOOO"}];var Level,__slice=[].slice;Level=function(){function t(t,e){this.game=e,this.load(t)}return t.prototype.w=0,t.prototype.h=0,t.prototype.treasures=0,t.prototype.ninjas=[],t.prototype.load=function(t){var e,r,n,i,o;return this.ninjas=[],this.treasures=0,e=function(){var e,r,i,o;for(i=t.data.split("\n"),o=[],e=0,r=i.length;r>e;e++)n=i[e],o.push(n.split(""));return o}(),this.map=function(){var t,s,h;for(h=[],o=t=0,s=e.length;s>t;o=++t)n=e[o],h.push(function(){var t,e,s;for(s=[],i=t=0,e=n.length;e>t;i=++t)switch(r=n[i]){case"@":s.push(new Dirt);break;case"O":s.push(new Rock);break;case"P":this.addPlayer(i,o),s.push(new Block);break;case"X":this.addNinja(i,o),s.push(new Block);break;case"*":this.treasures++,s.push(new Treasure);break;case"#":s.push(new Ladder);break;case"-":s.push(new Ladder(!0));break;default:s.push(new Block)}return s}.call(this));return h}.call(this),this.h=this.map.length,this.w=this.map[0].length},t.prototype.addNinja=function(t,e){var r,n,i;return n=t*gfx.tileW,i=e*gfx.tileH,r=new Ninja(this,n,i,this.game.player),this.ninjas.push(r)},t.prototype.addPlayer=function(t,e){return this.game.setPlayer(t*gfx.tileW,e*gfx.tileH,this)},t.prototype.removeBlock=function(t,e,r){return this.map[e][t]=new Block,r.constructor===Treasure&&0===--this.treasures?(alert("Level Complete!"),game.reset()):void 0},t.prototype.getBlockIndex=function(t,e){return[Math.floor(t/gfx.tileW),Math.floor(e/gfx.tileH)]},t.prototype.getBlockEdge=function(t,e){var r;return null==e&&(e=!1),r=e?gfx.tileH:gfx.tileW,utils.snap(t,r)},t.prototype.getBlock=function(t,e){var r,n,i,o;return i=this.getBlockIndex(t,e),r=i[0],n=i[1],(null!=(o=this.map[n])?o[r]:void 0)||new Rock},t.prototype.getBlocks=function(){var t,e,r,n,i,o,s;for(t=1<=arguments.length?__slice.call(arguments,0):[],s=[],n=0,i=t.length;i>n;n++)o=t[n],e=o[0],r=o[1],s.push(this.getBlock(e,r));return s},t.prototype.update=function(){var t,e,r,n,i,o,s,h,p,u,l,a,c,f,d,y,g;for(f=this.map,i=o=0,u=f.length;u>o;i=++o)for(r=f[i],n=s=0,l=r.length;l>s;n=++s)t=r[n],t.update(n,i,this);for(d=this.ninjas,h=0,a=d.length;a>h;h++)e=d[h],e.update();for(y=this.ninjas,g=[],p=0,c=y.length;c>p;p++)e=y[p],g.push(this.checkCollision(this.game.player,e));return g},t.prototype.checkCollision=function(t,e){return t.x+t.w>=e.x&&t.x<=e.x+e.w&&t.y+t.h>=e.y&&t.y<=e.y+e.h?(alert("You are dead."),game.reset()):void 0},t.prototype.render=function(t){var e,r,n,i,o,s,h,p,u,l,a,c,f,d;for(c=this.map,o=s=0,u=c.length;u>s;o=++s)for(n=c[o],i=h=0,l=n.length;l>h;i=++h)e=n[i],e.render(t,i*t.tileW,o*t.tileH);for(f=this.ninjas,d=[],p=0,a=f.length;a>p;p++)r=f[p],d.push(r.render(t));return d},t.prototype.digAt=function(t,e,r){var n,i,o,s;return s=this.getBlockIndex(e,r),i=s[0],o=s[1],i+="RIGHT"===t?1:-1,o+1>this.h||0>i||i>this.w-1?void 0:(n=this.map[o+1][i],null!=n.digIt&&n.digIt(),n.constructor===Block?this.map[o+1][i]=new Gravel:void 0)},t}(),this.game={init:function(){return gfx.init()?gfx.load(function(){return game.reset()}):(alert("Sorry, no canvas"),void 0)},stop:function(){return this.running=!1},start:function(){return this.running=!0},reset:function(){return this.player=new Player,this.level=new Level(levels[0],this),keys.reset(),this.running?void 0:(this.start(),this.tick())},setPlayer:function(t,e,r){return this.player.level=r,this.player.x=t,this.player.y=e},tick:function(){return this.running?(gfx.clear(),this.update(),this.render(),setTimeout(function(){return game.tick()},33)):void 0},update:function(){return this.level.update(),this.player.update()},render:function(){return this.level.render(gfx),this.player.render(gfx)}};