var utils;utils={now:function(){return(new Date).getTime()},snap:function(t,e){return Math.floor(t/e)*e},rand:function(t,e){var r;return null==e&&(e=t,t=0),r=e-t,Math.floor(Math.random()*r)+t},counter:function(t,e){return null==e&&(e=100),Math.floor(this.now()/e%t)}};var gfx;gfx={tileW:24,tileH:24,init:function(){var t;return t=$("#game")[0],this.ctx=null!=t?"function"==typeof t.getContext?t.getContext("2d"):void 0:void 0,this.ctx?(this.w=t.width,this.h=t.height,!0):!1},clear:function(){return this.ctx.clearRect(0,0,gfx.w,gfx.h)},load:function(t){return this.sprites=new Image,this.sprites.src="resources/sprites.png",this.sprites.onload=function(){return t()}},drawSprite:function(t,e,r,i,n,s,o){return null==n&&(n=1),null==s&&(s=1),null==o&&(o=1),n*=this.tileW,s*=this.tileH,this.ctx.drawImage(this.sprites,t*n,e*s,n,s,r,i,n*o,s*o)}};var keys;keys={up:!1,down:!1,left:!1,right:!1,space:!1,reset:function(){return this.up=this.down=this.left=this.right=this.space=!1},trigger:function(t,e,r){switch(t){case 37:this.left=e;break;case 39:this.right=e;break;case 38:this.up=e;break;case 40:this.down=e;break;case 32:e&&console.log("FIRE!"),this.space=e}return r.preventDefault()}},$(document).keydown(function(t){return keys.trigger(t.keyCode,!0,t)}),$(document).keyup(function(t){return keys.trigger(t.keyCode,!1,t)});var sound;sound={audio:{},list:{dig:"dig.wav",fall:"falling.wav",particle:"particle.wav",dead:"dead.wav"},init:function(){var t,e,r,i;r=this.list,i=[];for(t in r)e=r[t],i.push(this.audio[t]=new Audio("resources/"+e));return i},play:function(t){var e,r;return null!=(e=this.audio[t])&&(e.currentTime=0),null!=(r=this.audio[t])?r.play():void 0}},sound.init();var Entity;Entity=function(){function t(t,e,r){this.level=t,this.x=e,this.y=r,this.falling=!0,this.wasFalling=!0,this.onLadder=!1,this.wasOnLadder=!1,this.onTopOfLadder=!1}return t.prototype.x=0,t.prototype.y=0,t.prototype.w=18,t.prototype.h=24,t.prototype.speed=4,t.prototype.dir="LEFT",t.prototype.update=function(){},t.prototype.render=function(t){return t.ctx.fillText("?",this.x,this.y)},t.prototype.move=function(t,e){var r,i,n,s,o,a,h,l,p,u;return this.falling&&(e+=2*this.speed),this.wasFalling=this.falling,o=t,h=e,a=this.x+o,l=this.y+h,p=this.level.getBlocks([this.x,l],[this.x,l+(this.h-1)],[this.x+(this.w-1),l],[this.x+(this.w-1),l+(this.h-1)]),n=p[0],r=p[1],s=p[2],i=p[3],0>e&&(n.solid||s.solid)&&(h=this.level.getBlockEdge(this.y,"VERT")-this.y),e>0&&(r.solid||i.solid)&&(h=this.level.getBlockEdge(l+(this.h-1),"VERT")-this.y-this.h,this.falling=!1),u=this.level.getBlocks([a,this.y],[a,this.y+(this.h-1)],[a+(this.w-1),this.y],[a+(this.w-1),this.y+(this.h-1)]),n=u[0],r=u[1],s=u[2],i=u[3],0>t&&(n.solid||r.solid)&&(o=this.level.getBlockEdge(this.x)-this.x),t>0&&(s.solid||i.solid)&&(o=this.level.getBlockEdge(a+(this.w-1))-this.x-this.w),this.x+=o,this.y+=h,this.checkNewPos(t,e)},t.prototype.checkNewPos=function(t,e){var r,i,n,s,o,a,h,l,p,u,c;for(this.wasOnLadder=this.onLadder,c=this.level.getBlocks([this.x,this.y],[this.x,this.y+this.h],[this.x+(this.w-1),this.y],[this.x+(this.w-1),this.y+this.h]),a=c[0],r=c[1],l=c[2],n=c[3],s=c,p=0,u=s.length;u>p;p++)i=s[p],i.touchable&&i.touch(this);return this.onLadder=!1,h=s.some(function(t){return t.climbable}),h&&(this.onLadder=!0,this.falling=!1,0!==e&&(o=utils.snap(this.x,gfx.tileW),r.climbable||a.climbable||(this.x=o+gfx.tileW),n.climbable||l.climbable||(this.x=o))),this.onTopOfLadder=this.onLadder&&!(a.climbable||l.climbable)&&0===(this.y+this.h)%gfx.tileH,this.onLadder||this.falling||r.solid||n.solid||r.climbable||n.climbable?void 0:this.falling=!0},t}();var Ninja,__hasProp={}.hasOwnProperty,__extends=function(t,e){function r(){this.constructor=t}for(var i in e)__hasProp.call(e,i)&&(t[i]=e[i]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t};Ninja=function(t){function e(t,r,i,n){this.player=n,e.__super__.constructor.call(this,t,r,i)}return __extends(e,t),e.prototype.state="CRUISING",e.prototype.subState="IDLE",e.prototype.speed=3,e.prototype.time=0,e.prototype.render=function(t){var e;return e="LEFT"===this.dir?2:0,e+=utils.counter(2),t.drawSprite(e,1,this.x,this.y)},e.prototype.cruise=function(t,e){var r,i,n;switch(i=n=0,this.subState){case"RIGHT":i+=this.speed,this.dir="RIGHT";break;case"LEFT":i-=this.speed,this.dir="LEFT"}return--this.time<0&&(r=utils.rand(5),this.time=utils.rand(20,40),this.subState=function(){switch(r){case 0:case 1:return"LEFT";case 2:case 3:return"RIGHT";default:return"IDLE"}}()),this.onLadder&&!this.wasOnLadder&&Math.random()<.5&&(this.state="HUNTING"),e===this.y&&(this.state="HUNTING"),[i,n]},e.prototype.hunt=function(t,e){var r,i;return r=i=0,e===this.y||this.onTopOfLadder?t>this.x?(r+=this.speed,this.dir="RIGHT"):(r-=this.speed,this.dir="LEFT"):this.onLadder?(!this.onTopOfLadder&&e<this.y&&(i-=this.speed),e>this.y&&(i+=this.speed)):(this.state="CRUISING",this.subState="LEFT"),[r,i]},e.prototype.update=function(){var t,e,r,i,n;return n=function(){var r;if(this.falling)return[0,0];switch(r=this.player,t=r.x,e=r.y,this.state){case"CRUISING":return this.cruise(t,e);case"HUNTING":return this.hunt(t,e)}}.call(this),r=n[0],i=n[1],this.move(r,i)},e}(Entity);var Player,__hasProp={}.hasOwnProperty,__extends=function(t,e){function r(){this.constructor=t}for(var i in e)__hasProp.call(e,i)&&(t[i]=e[i]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t};Player=function(t){function e(){e.__super__.constructor.apply(this,arguments),this.dir="RIGHT"}return __extends(e,t),e.prototype.update=function(){var t,e;return t=e=0,this.falling||(keys.left&&(t-=this.speed,this.dir="LEFT"),keys.right&&(t+=this.speed,this.dir="RIGHT")),keys.down&&this.onLadder&&(e+=this.speed),keys.up&&this.onLadder&&!this.onTopOfLadder&&(e-=this.speed),keys.space&&this.dig(),this.move(t,e)},e.prototype.render=function(t){var e,r,i;return r=e=0,i="LEFT"===this.dir,this.falling?(i&&(e=1),r=2):(i&&(e=2),(keys.left||keys.right)&&(e+=utils.counter(2))),t.drawSprite(e,r,this.x,this.y)},e.prototype.dig=function(){return utils.now()-this.lastDig<500?void 0:(this.level.digAt(this.dir,this.x,this.y),this.lastDig=utils.now(),sound.play("dig"))},e}(Entity);var Block;Block=function(){function t(){}return t.prototype.touchable=!1,t.prototype.solid=!1,t.prototype.climbable=!1,t.prototype.update=function(){},t.prototype.render=function(){},t}();var Treasure,__hasProp={}.hasOwnProperty,__extends=function(t,e){function r(){this.constructor=t}for(var i in e)__hasProp.call(e,i)&&(t[i]=e[i]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t};Treasure=function(t){function e(){this.yOff=Math.random()*Math.PI}return __extends(e,t),e.prototype.touchable=!0,e.prototype.collected=!1,e.prototype.touch=function(t){return t.constructor===Player?this.collected=!0:void 0},e.prototype.update=function(t,e,r){return this.yOff+=Math.PI/24,this.collected?(sound.play("particle"),r.removeBlock(t,e,this)):void 0},e.prototype.render=function(t,e,r){var i;return i=Math.floor(4*Math.sin(this.yOff)),t.drawSprite(5,1,e,r+i)},e}(Block);var Dirt,_ref,__hasProp={}.hasOwnProperty,__extends=function(t,e){function r(){this.constructor=t}for(var i in e)__hasProp.call(e,i)&&(t[i]=e[i]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t};Dirt=function(t){function e(){return _ref=e.__super__.constructor.apply(this,arguments)}return __extends(e,t),e.prototype.solid=!0,e.prototype.render=function(t,e,r){var i;return i=t.ctx.globalAlpha,t.ctx.globalAlpha=1-this.digTime/80,t.drawSprite(4,1,e,r),t.ctx.globalAlpha=i},e.prototype.digIt=function(){return this.digTime=80,this.solid=!1},e.prototype.update=function(){return 50===--this.digTime?this.solid=!0:void 0},e}(Block);var Gravel,_ref,__hasProp={}.hasOwnProperty,__extends=function(t,e){function r(){this.constructor=t}for(var i in e)__hasProp.call(e,i)&&(t[i]=e[i]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t};Gravel=function(t){function e(){return _ref=e.__super__.constructor.apply(this,arguments)}return __extends(e,t),e.prototype.solid=!0,e.prototype.digTime=100,e.prototype.update=function(t,e,r){return--this.digTime<0?r.removeBlock(t,e,this):void 0},e.prototype.render=function(t,e,r){var i;return i=t.ctx.globalAlpha,t.ctx.globalAlpha=this.digTime/50,t.drawSprite(4,2,e,r),t.ctx.globalAlpha=i},e}(Block);var Rock,_ref,__hasProp={}.hasOwnProperty,__extends=function(t,e){function r(){this.constructor=t}for(var i in e)__hasProp.call(e,i)&&(t[i]=e[i]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t};Rock=function(t){function e(){return _ref=e.__super__.constructor.apply(this,arguments)}return __extends(e,t),e.prototype.solid=!0,e.prototype.render=function(t,e,r){return t.drawSprite(4,0,e,r)},e}(Block);var Ladder,__hasProp={}.hasOwnProperty,__extends=function(t,e){function r(){this.constructor=t}for(var i in e)__hasProp.call(e,i)&&(t[i]=e[i]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t};Ladder=function(t){function e(t){this.top=t,this.frame=t?6:5}return __extends(e,t),e.prototype.climbable=!0,e.prototype.render=function(t,e,r){return t.drawSprite(this.frame,0,e,r)},e}(Block);var levels;levels=[{name:"DIG and BUILD",data:"..................X.....\n@-@@.........@@@@@@@-@..\n.#..@@@....P........#...\n.#.....@@.@@.....X..#...\n@OO#.........#@@...O#..^\n...#.........#......#.^O\n...#..@@-@@@@#..-@@@@@OO\n...#....#....#..#.......\n...#....#....#..#.......\n...#....#....#..#.......\n@-@@OOOOO.#.@@@@@#@@-@@@\n.#.X......#......#..#...\n.#...*....#......#..#...\n####..@@#@@..-@@@@@@@..*\n####....#....#.........#\n####....#....#.........#\nOOOOOOOOOOOOOOOOOOOOOOOO"}];var Level,__slice=[].slice;Level=function(){function t(t,e){this.game=e,this.load(t)}return t.prototype.w=0,t.prototype.h=0,t.prototype.treasures=0,t.prototype.ninjas=[],t.prototype.load=function(t){var e,r,i,n,s;return this.ninjas=[],this.treasures=0,e=function(){var e,r,n,s;for(n=t.data.split("\n"),s=[],e=0,r=n.length;r>e;e++)i=n[e],s.push(i.split(""));return s}(),this.map=function(){var t,o,a;for(a=[],s=t=0,o=e.length;o>t;s=++t)i=e[s],a.push(function(){var t,e,o;for(o=[],n=t=0,e=i.length;e>t;n=++t)switch(r=i[n]){case"@":o.push(new Dirt);break;case"O":o.push(new Rock);break;case"P":this.addPlayer(n,s),o.push(new Block);break;case"X":this.addNinja(n,s),o.push(new Block);break;case"*":this.treasures++,o.push(new Treasure);break;case"#":o.push(new Ladder);break;case"-":o.push(new Ladder(!0));break;default:o.push(new Block)}return o}.call(this));return a}.call(this),this.h=this.map.length,this.w=this.map[0].length},t.prototype.addNinja=function(t,e){var r,i,n;return i=t*gfx.tileW,n=e*gfx.tileH,r=new Ninja(this,i,n,this.game.player),this.ninjas.push(r)},t.prototype.addPlayer=function(t,e){return this.game.setPlayer(t*gfx.tileW,e*gfx.tileH,this)},t.prototype.removeBlock=function(t,e,r){return this.map[e][t]=new Block,r.constructor===Treasure&&0===--this.treasures?(alert("Level Complete!"),game.reset()):void 0},t.prototype.getBlockIndex=function(t,e){return[Math.floor(t/gfx.tileW),Math.floor(e/gfx.tileH)]},t.prototype.getBlockEdge=function(t,e){var r;return null==e&&(e=!1),r=e?gfx.tileH:gfx.tileW,utils.snap(t,r)},t.prototype.getBlock=function(t,e){var r,i,n,s;return n=this.getBlockIndex(t,e),r=n[0],i=n[1],(null!=(s=this.map[i])?s[r]:void 0)||new Rock},t.prototype.getBlocks=function(){var t,e,r,i,n,s,o;for(t=1<=arguments.length?__slice.call(arguments,0):[],o=[],i=0,n=t.length;n>i;i++)s=t[i],e=s[0],r=s[1],o.push(this.getBlock(e,r));return o},t.prototype.update=function(){var t,e,r,i,n,s,o,a,h,l,p,u,c,d,f,y,g;for(d=this.map,n=s=0,l=d.length;l>s;n=++s)for(r=d[n],i=o=0,p=r.length;p>o;i=++o)t=r[i],t.update(i,n,this);for(f=this.ninjas,a=0,u=f.length;u>a;a++)e=f[a],e.update();for(y=this.ninjas,g=[],h=0,c=y.length;c>h;h++)e=y[h],g.push(this.checkCollision(this.game.player,e));return g},t.prototype.checkCollision=function(t,e){return t.x+t.w>=e.x&&t.x<=e.x+e.w&&t.y+t.h>=e.y&&t.y<=e.y+e.h?(sound.play("dead"),alert("You are dead."),game.reset()):void 0},t.prototype.render=function(t){var e,r,i,n,s,o,a,h,l,p,u,c,d,f;for(c=this.map,s=o=0,l=c.length;l>o;s=++o)for(i=c[s],n=a=0,p=i.length;p>a;n=++a)e=i[n],e.render(t,n*t.tileW,s*t.tileH);for(d=this.ninjas,f=[],h=0,u=d.length;u>h;h++)r=d[h],f.push(r.render(t));return f},t.prototype.digAt=function(t,e,r){var i,n,s,o;return o=this.getBlockIndex(e,r),n=o[0],s=o[1],n+="RIGHT"===t?1:-1,s+1>this.h||0>n||n>this.w-1?void 0:(i=this.map[s+1][n],null!=i.digIt&&i.digIt(),i.constructor===Block?this.map[s+1][n]=new Gravel:void 0)},t}(),this.game={init:function(){return gfx.init()?gfx.load(function(){return game.reset()}):(alert("Sorry, no canvas"),void 0)},stop:function(){return this.running=!1},start:function(){return this.running=!0},reset:function(){return this.player=new Player,this.level=new Level(levels[0],this),keys.reset(),this.running?void 0:(this.start(),this.tick())},setPlayer:function(t,e,r){return this.player.level=r,this.player.x=t,this.player.y=e},tick:function(){return this.running?(gfx.clear(),this.update(),this.render(),setTimeout(function(){return game.tick()},33)):void 0},update:function(){return this.level.update(),this.player.update()},render:function(){var t,e,r,i,n,s;return gfx.ctx.save(),gfx.ctx.scale(1.3,1.3),i=this.level.w*gfx.tileW,r=i/2,s=i/4.4+r,n=this.player.x>r?-this.player.x+r:0,this.player.x>s&&(n=-(i/4.4)),gfx.ctx.translate(n,-this.player.y+gfx.h/4),this.level.render(gfx),this.player.render(gfx),t=1-100*(this.player.x/gfx.w),e=1-100*(this.player.y/gfx.h),gfx.ctx.canvas.style.backgroundPosition=""+t+"px "+e+"px",gfx.ctx.restore()}};